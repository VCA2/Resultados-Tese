---
title: "Análise Quantitativa - Resultados Complementares"
author:
  - Vívian Costa Alves^[Universidade Federal de Santa Catarina - PPGEGC, vca2@uol.com.br]
date: "`r format(Sys.time(), '%B, %Y')`"
output:
  html_document:
    code_folding: show
    theme: cerulean
    highlight: breezedark
    toc: true
    toc_float: true
    number_sections: true 
---


***


# Setup e pacotes R
```{r Setup, message = FALSE, warning = FALSE}

## Opções iniciais de configuração do ambiente --------------
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
#### --------------------------------------------------------
library("stringr")  # funções de manipulação de chars
library("dplyr")    # gramática de wrangling
library("ggplot2")  # apresentação gráfica
library("tibble")   # data sets melhorados
library("magrittr") # semantica serializada de instruções
library("readxl")   # leitor de arquivos excel
library("purrr")    # programação funcional
library("knitr")    # Uso de tabelas Kable para apresentação
#### --------------------------------------------------------
theme_update(text = element_text(size=16)) ## Tamanho das fontes nos gráficos
v_path_i <- "./Dados originais/" ## Caminho para leitura de arquivos de input
v_path_o <- "./Analises/" ## Caminho para geração de arquivos de output
v_path_inter <- "./Resultados intermediarios/" ## Caminho para geração de arquivos intermediarios
```


***

# Datasets

## Programas e Projetos

<p align="justify">Leitura de planilhas e criação de datasets para programas e projetos-PPG. Filtro de projetos com início de 2013 em diante. Também nesta etapa foi realizada a criação de dataset com as categorias utilizadas na apresentação dos dados (ds_prg).</p>

```{r Carga de Programas e Projetos, message=FALSE, warning=FALSE}

ds_prgppg <- read_excel(paste0(v_path_i, "Programas PPG 2016.xlsx"))
ds_prjppg <- read_excel(paste0(v_path_i, "Projetos PPG 2016.xlsx"))

ds_siglas <- read_excel(paste0(v_path_i, "Siglas áreas de avaliação.xlsx")) %>% 
             select(nome = "Nome área de avaliação",
                    sigla = "Sigla")

ds_prg <- ds_prgppg %>% merge(., ds_siglas, by.x = "NM_AREA_AVALIACAO", by.y = "nome") %>%  # Incluindo sigla
                        select(CD_PROGRAMA_IES,
                               NM_AREA_AVALIACAO,
                               SG_AREA_AVALIACAO = sigla,
                               CS_STATUS_JURIDICO,
                               DS_DEPENDENCIA_ADMINISTRATIVA,
                               ANO_INICIO_PROGRAMA,
                               NM_MODALIDADE_PROGRAMA,
                               CD_CONCEITO_PROGRAMA,
                               NM_REGIAO,             # Novas categorias
                               SG_UF_PROGRAMA,        #
                               SG_ENTIDADE_ENSINO,    #
                               NM_PROGRAMA_IES,       #
                               NM_GRAU_PROGRAMA)

 write.csv2(ds_prg, paste0(v_path_inter, "ds_prg.csv"))

ds_prjppg_13_16 <- ds_prjppg %>% 
  mutate(ANO_PRJ = str_sub(.$DH_INICIO, 1, 4)) %>%
  filter(ANO_PRJ >= 2013)

 write.csv2(ds_prjppg_13_16, paste0(v_path_inter, "ds_prjppg_13_16.csv"))

rm(ds_prjppg) ## Limpeza de memória
```

## Membros de Projetos

<p align="justify">Leitura de planilhas e criação de datasets com dados de membros de projetos entre 2013 e 2016.</p>

```{r Membros de projetos 2013-2016, message=FALSE, warning=FALSE}

f.membros <- function(file){
  ds <- read_excel(file) %>%
    arrange(DS_TIPO_MEMBRO) %>% 
    filter(DS_TIPO_MEMBRO %in% c("DISCENTE","DOCENTE")) %>% 
    merge(., ds_prjppg_13_16, by = "ID_PROJETO")
  return(ds)
}

ds_membros_13_16 <- rbind(f.membros(paste0(v_path_i, "Membros dos projetos 2013.xlsx")),
                          f.membros(paste0(v_path_i, "Membros dos projetos 2014.xlsx")),
                          f.membros(paste0(v_path_i, "Membros dos projetos 2015.xlsx")),
                          f.membros(paste0(v_path_i, "Membros dos projetos 2016.xlsx")))

 write.csv2(ds_membros_13_16, paste0(v_path_inter, "ds_membros_13_16.csv"))
```

## Formação discente e docente

<p align="justify">Leitura de planilhas e criação de datasets para dados de formação de professores e alunos nos programas de mestrado e doutorado. Os campos comuns foram selecionados e padronizados para os três arquivos para facilitar relacionamento com indicadores.</p>

```{r Formações, message=FALSE, warning=FALSE}

v_form_campos <- c("nro_id_cnpq", "seq_pessoa_fisica",
                   "nome_sucupira", "nome_cvlattes",
                   "nome_filtro_cvlattes", "sgl_instituicao",
                   "nme_instituicao", "cod_programa",
                   "nme_programa", "nme_area_avaliacao",
                   "seq_area_basica", "area_basica",
                   "grande_area_basica", "nro_nota_doutorado",
                   "nro_nota_mestrado", "nro_nota_mestrado_prof",
                   "dta_fim", "seq_tipo_categoria_vinculo",
                   "nivel_formacao", "ano_inicio_formacao",
                   "ano_fim_formacao", "formacao_concluida",
                   "sigla_pais_ies_formacao", "sigla_uf_ies_formacao",
                   "sigla_ies_formacao", "nome_ies_formacao",
                   "nome_curso_formacao", "cod_area_curso_formacao",
                   "grande_area_curso_formacao", "area_curso_formacao")

ds_frmdic <- read_excel(paste0(v_path_i, "Formação dos discentes 2013-2016 - Tese.xlsx")) %>% 
  mutate(nro_id_cnpq = str_pad(as.character(nro_id_cnpq), 
                               width =  16, 
                               side = "left", 
                               pad = "0"),
         seq_pessoa_fisica = as.character(seq_pessoa_fisica)) %>% 
  select(v_form_campos) %>% 
  mutate(doc_ou_disc = "DISCENTE")

 write.csv2(ds_frmdic, paste0(v_path_inter, "ds_frmdic.csv"))

ds_frmdic_mestrado <- read_excel(paste0(v_path_i, "Dicentes mestrado tratada -tese.xlsx")) %>% 
  mutate(nro_id_cnpq = str_pad(as.character(nro_id_cnpq), 
                               width =  16, 
                               side = "left", 
                               pad = "0"),
         seq_pessoa_fisica = as.character(seq_pessoa_fisica)) %>% 
  select(v_form_campos) %>% 
  mutate(doc_ou_disc = "DISCENTE")

 write.csv2(ds_frmdic_mestrado, paste0(v_path_inter, "ds_frmdic_mestrado.csv"))

ds_frmdoc <- read_excel(paste0(v_path_i, "Formação dos docentes tese.xlsx")) %>% 
  select(v_form_campos) %>% 
  mutate(doc_ou_disc = "DOCENTE")

 write.csv2(ds_frmdoc, paste0(v_path_inter, "ds_frmdoc.csv"))
```

# Indice de Multi/Interdisciplinaridade

<p align="justify">Preparação, transformações e calculo de variáveis e indicadores que compõe o IMI - Indice de Multi/Inter disciplinaridade.</p>


***


## IMI 1 - Formação docente
### FCDo - Diversidade da formação dos docentes nos PPG

**Variáveis:** <br>
**QPPP:**   Quantidade de professores permanentes do programa <br>
**QFDPD:**  Quantidade das formações dos docentes permanentes no grau de doutorado <br>
**QFDPM:**  Quantidade das formações dos docentes permanentes no grau de mestrado <br>
**QFDPG:**  Quantidade das formações dos docentes permanentes no grau de graduação <br>

**Indicadores:** <br>
**DFDDo:**  Diversidade de formação do docente pelo grau de doutorado <br>
**DFDM:**   Diversidade de formação do docente pelo grau de mestrado <br>
**DFDG:**   Diversidade de formação do docente pelo grau de graduação <br>

`OBS` *- Os agrupamentos e sumarizações abaixo são realizados em dois estágios progressivos para garantir contagens adequadas no calculo das variáveis.*

```{r Formação docente, message=FALSE, warning=FALSE, paged.print=TRUE}

ds_IMI1_QPPP <- ds_frmdoc %>% 
  group_by(cod_programa, nome_filtro_cvlattes) %>% 
  summarise(QT = n()) %>% 
  group_by(cod_programa) %>% 
  summarise(QPPP = n())

 write.csv2(ds_IMI1_QPPP, paste0(v_path_inter, "ds_IMI1_QPPP.csv"))

ds_IMI1_QFDPD <- ds_frmdoc %>% 
  filter(nivel_formacao == "Doutorado") %>% 
  group_by(cod_programa, nome_curso_formacao) %>% 
  summarise(QT = n()) %>%   
  group_by(cod_programa) %>% 
  summarise(QFDPD = n()) 

 write.csv2(ds_IMI1_QFDPD, paste0(v_path_inter, "ds_IMI1_QFDPD.csv"))

ds_IMI1_QFDPM <- ds_frmdoc %>% 
  filter(nivel_formacao == "Mestrado") %>% 
  group_by(cod_programa, nome_curso_formacao) %>% 
  summarise(QT = n()) %>%   
  group_by(cod_programa) %>% 
  summarise(QFDPM = n()) 

 write.csv2(ds_IMI1_QFDPM, paste0(v_path_inter, "ds_IMI1_QFDPM.csv"))

ds_IMI1_QFDPG <- ds_frmdoc %>% 
  filter(nivel_formacao == "Graduação") %>% 
  group_by(cod_programa, nome_curso_formacao) %>% 
  summarise(QT = n()) %>%   
  group_by(cod_programa) %>% 
  summarise(QFDPG = n()) 

 write.csv2(ds_IMI1_QFDPG, paste0(v_path_inter, "ds_IMI1_QFDPG.csv"))

ds_IMI1_FCDo <- merge(ds_IMI1_QFDPD, ds_IMI1_QFDPM, by = "cod_programa", all.x = T) %>% 
  merge(., ds_IMI1_QFDPG, by = "cod_programa", all.x = T) %>% 
  merge(., ds_IMI1_QPPP, by = "cod_programa", all.x = T) %>% 
  mutate(DFDDo = QFDPD/QPPP,
         DFDM = QFDPM/QPPP,
         DFDG = QFDPG/QPPP) %>% ## Fórmulas dos indicadores
  #mutate(DFDDo = ifelse(DFDDo <= 1, DFDDo, 1),  
  #       DFDM = ifelse(DFDM <= 1, DFDM, 1), 
  #       DFDG = ifelse(DFDG <= 1, DFDG, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  mutate(FCDo = (DFDDo + DFDM + DFDG)/3) %>% ## Fórmula do constructo
  merge(ds_prg, ., by.x = "CD_PROGRAMA_IES", by.y = "cod_programa", all.y = T) ## Categorias

 write.csv2(ds_IMI1_FCDo, paste0(v_path_o, "FCDo.csv"))
 kable(ds_IMI1_FCDo[1:12, ]) #c(1,8:15)]) ## Amostra do arquivo gerado acima, sem as categorias
```

## IMI 2 - Formação discente
### FCDi - Diversidade na formação dos discentes nos PPG

**Variáveis:** <br>
**QFGDi:**  Quantidade das formações dos discentes no grau de graduação <br>
**QDP:**    Quantidade de discentes do programa <br>

**Indicadores:** <br>
**DFGDi:**  Diversidade de formação do discente  pelo grau de graduação <br>

```{r Formação discente, message=FALSE, warning=FALSE, paged.print=TRUE}

ds_frmdic_ttl <- rbind(ds_frmdic, ds_frmdic_mestrado) %>% 
  filter(nivel_formacao == "Graduação") %>% 
  group_by(cod_programa, 
           nome_filtro_cvlattes, 
           doc_ou_disc,
           nome_curso_formacao) %>%
  summarise(QT = n()) ## Junção de formações de discentes e filtro de graduação

 write.csv2(ds_frmdic_ttl, paste0(v_path_inter, "ds_frmdic_ttl.csv"))

ds_IMI2_QDP <- ds_frmdic_ttl %>% 
  group_by(cod_programa, nome_filtro_cvlattes) %>% 
  summarise(QT = n()) %>% 
  group_by(cod_programa) %>% 
  summarise(QDP = n())

 write.csv2(ds_IMI2_QDP, paste0(v_path_inter, "ds_IMI2_QDP.csv"))

ds_IMI2_QFGDi <- ds_frmdic_ttl %>% 
  group_by(cod_programa, nome_curso_formacao) %>% 
  summarise(QT = n()) %>%   
  group_by(cod_programa) %>% 
  summarise(QFGDi = n()) 

 write.csv2(ds_IMI2_QFGDi, paste0(v_path_inter, "ds_IMI2_QFGDi.csv"))

ds_IMI2_FCDi <- merge(ds_IMI2_QFGDi, ds_IMI2_QDP, by = "cod_programa", all.x = T) %>% 
  mutate(DFGDi = QFGDi/QDP) %>% ## Fórmula do indicador
  #mutate(DFGDi = ifelse(DFGDi <= 1, DFGDi, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  mutate(FCDi = DFGDi) %>%  ## Fórmula do constructo
  merge(ds_prg, ., by.x = "CD_PROGRAMA_IES", by.y = "cod_programa", all.y = T) ## Categorias

 write.csv2(ds_IMI2_FCDi, paste0(v_path_o, "FCDi.csv"))
 kable(ds_IMI2_FCDi[1:12, ]) #c(1,8:11)]) ## Amostra do arquivo gerado acima, sem as categorias
```

## IMI 3 - Instituições participantes e membros de projetos
### CC - Colaboração Científica

**Variáveis:** <br>
**QIP:**    Quantidade de instituições participantes nos projetos <br>
**QPP:**    Quantidade de projetos no programa <br>

#### Intituições
```{r Instituições, message=FALSE, warning=FALSE, paged.print=TRUE}

ds_fin <-  rbind(read_excel(paste0(v_path_i, "Financiadores de proejtos 2013.xlsx")),
                 read_excel(paste0(v_path_i, "Financiadores de projetos 2014.xlsx")),
                 read_excel(paste0(v_path_i, "Financiadores de projetos 2015.xlsx")),
                 read_excel(paste0(v_path_i, "Financiadores de proejtos 2016.xlsx"))) ## Carga de Instituições

ds_IMI3_QIP <- ds_fin %>% 
  group_by(CD_PROGRAMA_IES, NM_FINANCIADOR) %>% 
  summarise(QT = n()) %>% 
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(QIP = n())

 write.csv2(ds_IMI3_QIP, paste0(v_path_inter, "ds_IMI3_QIP.csv"))

ds_IMI3_QPP <- ds_fin %>% 
  group_by(CD_PROGRAMA_IES, ID_PROJETO) %>% 
  summarise(QT = n()) %>% 
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(QPP = n())

 write.csv2(ds_IMI3_QPP, paste0(v_path_inter, "ds_IMI3_QPP.csv"))
```

**Variáveis:** <br>
**DFPP:**   Diversidade formações dos participantes dos projetos (graduação). <br>
**QMP:**    Quantidade de membros dos projetos <br>

**Indicadores:** <br>
**DFCP:**   Diversidade de formações que colaboram por meio de projetos <br>

`OBS` *- As variáveis e indicadores abaixo são consolidadas no nível de projeto e depois sumarizadas por média em programas para possibilitar cruzamento com demais constructos.*

#### Colaboração
```{r Formações de colaboradores, message=FALSE, warning=FALSE, paged.print=TRUE}

ds_formacao_grd <- rbind(ds_frmdic, ds_frmdoc, ds_frmdic_mestrado) %>% 
  filter(nivel_formacao == "Graduação") %>% 
  group_by(cod_programa, 
           nome_filtro_cvlattes, 
           doc_ou_disc,
           nome_curso_formacao) %>%
  summarise(QT = n()) ## Junção de formações de todos os membros e filtro de graduação

 write.csv2(ds_formacao_grd, paste0(v_path_inter, "ds_formacao_grd.csv"))

ds_MbrPrj_grd <- merge(ds_membros_13_16, ds_formacao_grd, 
                       by.x = c("CD_PROGRAMA_IES", "NM_MEMBRO_PROJETO", "DS_TIPO_MEMBRO"), 
                       by.y = c("cod_programa", "nome_filtro_cvlattes", "doc_ou_disc")) #@ Junção de 
                                                                                        ## membros e formações

 write.csv2(ds_MbrPrj_grd, paste0(v_path_inter, "ds_MbrPrj_grd.csv"))

ds_IMI3_DFPP <- ds_MbrPrj_grd %>% 
  group_by(CD_PROGRAMA_IES, ID_PROJETO, nome_curso_formacao) %>% 
  summarise(QT = n()) %>% 
  group_by(CD_PROGRAMA_IES, ID_PROJETO) %>% 
  summarise(DFPP = n()) 

 write.csv2(ds_IMI3_DFPP, paste0(v_path_inter, "ds_IMI3_DFPP.csv"))

ds_IMI3_QMP <- ds_MbrPrj_grd %>% 
  group_by(CD_PROGRAMA_IES, ID_PROJETO, NM_MEMBRO_PROJETO) %>% 
  summarise(QT = n()) %>% 
  group_by(CD_PROGRAMA_IES, ID_PROJETO) %>% 
  summarise(QMP = n()) 

 write.csv2(ds_IMI3_QMP, paste0(v_path_inter, "ds_IMI3_QMP.csv"))

#### Geração de arquivo de colaboração no nível de projetos para conferência de dados -----------

ds_DFCP <- merge(ds_IMI3_DFPP, ds_IMI3_QMP , by = c("CD_PROGRAMA_IES", "ID_PROJETO")) %>% 
  mutate(DFCP = DFPP/QMP)# %>% 
  #mutate(DFCP = ifelse(DFCP <= 1, DFCP, 1)) ## Limpeza de ocorrências acima de 1.0
 
 write.csv2(ds_DFCP, paste0(v_path_o, "DFCP.csv"))
#### --------------------------------------------------------------------------------------------
kable(ds_DFCP[1:12, ]) ## Amostra do arquivo gerado acima

ds_IMI3_DFCP <- merge(ds_IMI3_DFPP, ds_IMI3_QMP, by = c("CD_PROGRAMA_IES", "ID_PROJETO")) %>% 
  mutate(DFCP = DFPP/QMP) %>% ## Fórmula do indicador
  #mutate(DFCP = ifelse(DFCP <= 1, DFCP, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(DFPP = mean(DFPP),
            QMP = mean(QMP),
            DFCP = mean(DFCP)) ## Consolidação de variáveis e indicador

 write.csv2(ds_IMI3_DFCP, paste0(v_path_inter, "ds_IMI3_DFCP.csv"))
```

**Indicadores:** <br>
**DIPP:**   Diversidade de instituições que que colaboram por meio dos projetos <br>

#### Consolidação da Colaboração Científica
```{r Constructo completo, message=FALSE, warning=FALSE, paged.print=TRUE}

ds_IMI3_CC <- merge(ds_IMI3_QIP, ds_IMI3_QPP, by = "CD_PROGRAMA_IES", all.x = T) %>% 
  merge(., ds_IMI3_DFCP, by = "CD_PROGRAMA_IES", all.x = T) %>% ## Junção com indicador de
                                                                ## diversidade de formações 
                                                                ## de colaboradores
  mutate(DIPP = QIP/QPP) %>% ## Fórmula do indicador
  #mutate(DIPP = ifelse(DIPP <= 1, DIPP, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  mutate(CC = (DFCP + DIPP)/2) ## Fórmula do constructo
  
ds_IMI3_CC <-  ds_IMI3_CC[,c(1:3, 7, 4:6, 8)] ## Reordenação de campos

ds_IMI3_CC %<>% merge(ds_prg, ., by = "CD_PROGRAMA_IES", all.y = T) ## Categorias

 write.csv2(ds_IMI3_CC, paste0(v_path_o, "CC.csv"))
 kable(ds_IMI3_CC[1:12, ]) #c(1,8:14)]) ## Amostra do arquivo gerado acima, sem as categorias
```

## IMI 4 - Áreas de atuação de docentes
### CP - Contexto Profissional

**Variáveis:** <br>
**QCDI:**   Quantidade de combinações distintas informadas <br>
**QGAD:**   Quantidade de grande áreas de conhecimento que o docente atua <br>
**QACD:**   Quantidade de áreas do conhecimento que o docente atua <br>

**Indicadores:** <br>
**DGAC:**   Diversidade de grande áreas do conhecimento que o docente atua <br>
**DAC:**    Diversidade de áreas do conhecimento que o docente atua <br>

```{r Contexto Profissional, message=FALSE, warning=FALSE, paged.print=TRUE}
ds_aratdo <- read_excel(paste0(v_path_i, 'Areas_de_atuacao_docentes_25_06_2019.xlsx'))

ds_IMI4_QCDI <- ds_aratdo %>% 
  mutate(espec_doc = paste0(grande_area, nome_area, sub_area, especialidade)) %>% 
  group_by(cod_programa, nome_filtro_cvlattes, espec_doc) %>% 
  summarise(QT = n()) %>% 
  group_by(cod_programa, nome_filtro_cvlattes) %>% 
  summarise(QCDI = n())

 write.csv2(ds_IMI4_QCDI, paste0(v_path_inter, "ds_IMI4_QCDI.csv"))

ds_IMI4_QGAD <- ds_aratdo %>%
  group_by(cod_programa, nome_filtro_cvlattes, grande_area) %>% 
  summarise(QT = n()) %>% 
  group_by(cod_programa, nome_filtro_cvlattes) %>% 
  summarise(QGAD = n())

 write.csv2(ds_IMI4_QGAD, paste0(v_path_inter, "ds_IMI4_QGAD.csv"))

ds_IMI4_QACD <- ds_aratdo %>%
  group_by(cod_programa, nome_filtro_cvlattes, nome_area) %>% 
  summarise(QT = n()) %>% 
  group_by(cod_programa, nome_filtro_cvlattes) %>% 
  summarise(QACD = n())

 write.csv2(ds_IMI4_QACD, paste0(v_path_inter, "ds_IMI4_QACD.csv"))

ds_IMI4_CP <- merge(ds_IMI4_QGAD, ds_IMI4_QACD, by = c("cod_programa","nome_filtro_cvlattes"), all.x = T) %>% 
  merge(., ds_IMI4_QCDI, by = c("cod_programa","nome_filtro_cvlattes"), all.x = T) %>% 
  mutate(DGAC = QGAD/QCDI,
         DAC = QACD/QCDI) %>% ## Fórmulas dos indicadores
  #mutate(DGAC = ifelse(DGAC <= 1, DGAC, 1),
  #       DAC = ifelse(DAC <= 1, DAC, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  mutate(CP = (DGAC + DAC)/2) ## Fórmula do constructo

 write.csv2(ds_IMI4_CP, paste0(v_path_o, "CP_docente.csv"))
 kable(ds_IMI4_CP[1:12, ]) ## Amostra do arquivo gerado acima

ds_IMI4_CP_pgr <- ds_IMI4_CP %>% 
  group_by(cod_programa) %>% 
  summarise(CP = mean(CP)) %>% ## Consolidação por programa
  merge(ds_prg, ., by.x = "CD_PROGRAMA_IES", by.y = "cod_programa", all.y = T) ## Categorias

 write.csv2(ds_IMI4_CP_pgr, paste0(v_path_o, "CP_programa.csv"))
 kable(ds_IMI4_CP_pgr[1:12, ]) #c(1,8)]) ## Amostra do arquivo gerado acima, sem as categorias
```

## Consolidação final do IMI

<p align="justify">Junção de todos os constructos, limpeza de casos imcompletos e geração de output.</p>

```{r Calculo final do IMI, message=FALSE, warning=FALSE, paged.print=TRUE}
ds_IMI <- merge(ds_IMI1_FCDo[,c("CD_PROGRAMA_IES", "FCDo")], 
                ds_IMI2_FCDi[,c("CD_PROGRAMA_IES", "FCDi" )], 
                by = "CD_PROGRAMA_IES", all = T) %>% 
  merge(., ds_IMI3_CC[,c("CD_PROGRAMA_IES","CC")], 
        by = "CD_PROGRAMA_IES", all = T) %>% 
  merge(., ds_IMI4_CP_pgr[,c("CD_PROGRAMA_IES","CP")], 
        by = "CD_PROGRAMA_IES", all = T) 

ds_IMI <- ds_IMI[complete.cases(ds_IMI),] ## Casos completos

ds_IMI %<>% mutate(IMI = (FCDo + FCDi + CC + CP)/4) %>% 
  merge(ds_prg, ., by = "CD_PROGRAMA_IES", all.y = T) ## Categorias

 write.csv2(ds_IMI, paste0(v_path_o, "IMI.csv"))
 kable(ds_IMI[1:12, ]) #c(1,8:12)]) ## Amostra do arquivo gerado acima, sem as categorias
```


***


# Indice de Produção Tecnologica

<p align="justify">Preparação, transformações e calculo de variáveis e indicadores que compõe o IPT - Indice de Produção Tecnologica.</p>

**Variáveis:** <br>
**SPPP:**   Soma de patentes produzidos por programa <br>
**SPPPr:**  Soma de produtos produzidos por programa <br>
**SAPP:**   Soma de aplicativos produzidos por programa <br>
**QPPP:**   Quantidade de professores permanentes do programa <br>

**Indicadores:** <br>
**QPPa:**  Quantitativo de produção de patentes por Programa <br>
**QPPr:**  Quantitativo de produção de produtos por Programa <br>
**QPA:**   Quantitativo de produção de aplicativos por Programa <br>

```{r IPT, message=FALSE, warning=FALSE, paged.print=TRUE}

#### Carga de Aplicativos, patentes e PRodutos a partir de planilhas ----------------------------

ds_PT_appprg <- read_excel(paste0(v_path_i, "Aplicativos_tese.xlsx"))
ds_PT_patprg <- read_excel(paste0(v_path_i, "Patentes com Programas.xlsx"))
ds_PT_prdprg <- read_excel(paste0(v_path_i, "Produtos_tese.xlsx"))

#### --------------------------------------------------------------------------------------------

ds_PT_patprg <- ds_PT_patprg[complete.cases(ds_PT_patprg[,"NM_PRODUCAO"]),] ## Filtro de produção valida

ds_IPT1_SPPP<- ds_PT_patprg %>%
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(SPPP = n())

 write.csv2(ds_IPT1_SPPP, paste0(v_path_inter, "ds_IPT1_SPPP.csv"))

#### --------------------------------------------------------------------------------------------

ds_PT_prdprg <- ds_PT_prdprg[complete.cases(ds_PT_prdprg[,"DSFINALIDADE_TRATADA"]),] ## Filtro de produção valida

ds_IPT2_SPPPr <- ds_PT_prdprg %>%
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(SPPPr = n())

 write.csv2(ds_IPT2_SPPPr, paste0(v_path_inter, "ds_IPT2_SPPPr.csv"))

#### --------------------------------------------------------------------------------------------

ds_PT_appprg <- ds_PT_appprg[complete.cases(ds_PT_appprg[,"DS_FINALIDADE"]),] ## Filtro de produção valida

ds_IPT3_SAPP <- ds_PT_appprg %>%
  group_by(CD_PROGRAMA_IES) %>% 
  summarise(SAPP = n())

 write.csv2(ds_IPT3_SAPP, paste0(v_path_inter, "ds_IPT3_SAPP.csv"))

#### --------------------------------------------------------------------------------------------

ds_IPT <- merge(ds_IMI1_QPPP, ds_IPT1_SPPP, by.x = "cod_programa", by.y = "CD_PROGRAMA_IES", all.x = T) %>% 
  select(CD_PROGRAMA_IES = cod_programa, QPPP, SPPP) %>% 
  merge(., ds_IPT2_SPPPr, by = "CD_PROGRAMA_IES", all.x = T) %>% 
  merge(., ds_IPT3_SAPP, by = "CD_PROGRAMA_IES", all.x = T)

ds_IPT[is.na(ds_IPT)] <- 0 ### Conversão de NA para 0

# ds_IPT %<>% mutate(QPPa = SPPP/QPPP,
#                    QPPr = SPPPr/QPPP,
#                    QPA = SAPP/QPPP) %>% ## Fórmulas dos indicadores
#   #mutate(QPPa = ifelse(QPPa <= 1, QPPa, 1),
#   #       QPPr = ifelse(QPPr <= 1, QPPr, 1),
#   #       QPA = ifelse(QPA <= 1, QPA, 1)) %>% ## Limpeza de ocorrências acima de 1.0
#   mutate(IPT = (QPPa+QPPr+QPA)/3) %>% ## Fórmula do indice
#   merge(ds_prg, ., by = "CD_PROGRAMA_IES", all.y = T) ## Categorias

ds_IPT %<>% mutate(QPPa = SPPP,
                   QPPr = SPPPr,
                   QPA = SAPP) %>% ## Fórmulas dos indicadores
  #mutate(QPPa = ifelse(QPPa <= 1, QPPa, 1),
  #       QPPr = ifelse(QPPr <= 1, QPPr, 1),
  #       QPA = ifelse(QPA <= 1, QPA, 1)) %>% ## Limpeza de ocorrências acima de 1.0
  mutate(IPT = (QPPa+QPPr+QPA)/QPPP) %>% ## Fórmula do indice
  merge(ds_prg, ., by = "CD_PROGRAMA_IES", all.y = T) ## Categorias

 write.csv2(ds_IPT, paste0(v_path_o, "IPT.csv"))
 kable(ds_IPT[1:12, ]) #c(1,8:15)]) ## Amostra do arquivo gerado acima, sem as categorias
 
 
 # [,c(1,14:21)] Seleção de campos, obsoleto
 ds_IMI_IPT <- merge(ds_IMI, ds_IPT, by = "CD_PROGRAMA_IES", all = T) ## Novo DS para avaliação de IMI x IPT
 write.csv2(ds_IMI_IPT, paste0(v_path_o, "IMI_IPT.csv"))              ##
```


***


# Tabela base de indices completos e correlação geral

<p align="justify">União de indices por programa, filtro de cassos completos, categorização e calculo de correlação geral.</p>

```{r Base de correlações e correlação geral, message=FALSE, warning=FALSE, paged.print=TRUE}
ds_COR <- merge(ds_IMI[,c(1,18)], ds_IPT[,c(1,21)], by = "CD_PROGRAMA_IES", all = T) ## União de indices

ds_COR <- ds_COR[complete.cases(ds_COR),] ## Filtro de casos completos

ds_COR %<>% filter(IPT > 0)%>% ## Filtro de projetos com produção tecnologica
  merge(ds_prg, ., by = "CD_PROGRAMA_IES", all.y = T) ## Categorias

 write.csv2(ds_COR, paste0(v_path_o, "COR.csv"))
 kable(ds_COR[1:12, ]) #c(1,8:9)]) ## Amostra do arquivo gerado acima, sem as categorias
 
ds_COR_p <- ds_COR %>% 
  select(IMI, IPT) %>% 
  cor(., method = "pearson") ## Correlação geral pearson

 write.csv2(ds_COR_p, paste0(v_path_o, "COR_p.csv"))
 as_tibble(ds_COR_p) ## Tabela de correlação Geral pearson

  
ds_COR_k <- ds_COR %>% 
  select(IMI, IPT) %>% 
  cor(., method = "kendall") ## Correlação geral kendall

 write.csv2(ds_COR_k, paste0(v_path_o, "COR_k.csv"))
 as_tibble(ds_COR_k) ## Tabela de correlação Geral kendall

 
 ds_COR_s <- ds_COR %>% 
  select(IMI, IPT) %>% 
  cor(., method = "spearman") ## Correlação geral spearman

 write.csv2(ds_COR_s, paste0(v_path_o, "COR_s.csv"))
 as_tibble(ds_COR_s) ## Tabela de correlação Geral spearman
 

```


***


# Correlação por categoria

<p align="justify">Segmentação de tabela base de indice por cada categoria: Ano, Conceito, Dependencia, Area, Status e Modalidade. Geração de todos os outputs.</p>

```{r Correlação por categoria, message=FALSE, warning=FALSE, paged.print=TRUE}
##### ---------------------------------------------------------------------------------------
f.corr <- function(df, mtd = "pearson"){
  df %<>% select(IMI,IPT) %>% 
    cor(., method = mtd)
  return(df)
} ## Função para aplicação de correlação em cada sessão do split por categoria

f.print_corr <- function(df){
  dfo <- tibble(cat = as.character(), cor = as.double()) ## Mudança de objeto pois "tibble 3.0" apresentou erro
  for (i in seq_along(df)) {
    dfo[i,] <- list(names(df[i]), df[[i]][1,2])
  }
  return(dfo)
} ## Função para criação de dataset com correlação por item de categoria

##### ---------------------------------------------------------------------------------------
ano_f <- factor(ds_COR$ANO_INICIO_PROGRAMA) ## Fator para split de categoria

ds_COR_ano <- ds_COR %>% select(ANO_INICIO_PROGRAMA,IMI,IPT) %>% 
  split(ano_f, drop = T) %>% ## Separação por ano
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_ano <- as.tibble(f.print_corr(ds_COR_ano))

ds_COR_ano <- ds_COR %>% group_by(ANO_INICIO_PROGRAMA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana                                   
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_ano, by.x = "ANO_INICIO_PROGRAMA", by.y = "cat", all = T) %>% 
              mutate(ANO_INICIO_PROGRAMA = as.character(ANO_INICIO_PROGRAMA))
  
 write.csv2(ds_COR_ano, paste0(v_path_o, "COR_ano.csv"))
 kable(ds_COR_ano)
##### ---------------------------------------------------------------------------------------
conceito_f <- factor(ds_COR$CD_CONCEITO_PROGRAMA) ## Fator para split de categoria

ds_COR_conceito <- ds_COR %>% select(CD_CONCEITO_PROGRAMA,IMI,IPT) %>% 
  split(conceito_f, drop = T) %>% ## Separação por conceito
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_conceito <- f.print_corr(ds_COR_conceito)

ds_COR_conceito <- ds_COR %>% group_by(CD_CONCEITO_PROGRAMA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_conceito, by.x = "CD_CONCEITO_PROGRAMA", by.y = "cat", all = T) %>% 
              mutate(ANO_INICIO_PROGRAMA = as.character(CD_CONCEITO_PROGRAMA))

 write.csv2(ds_COR_conceito, paste0(v_path_o, "COR_conceito.csv"))
 kable(ds_COR_conceito)
##### ---------------------------------------------------------------------------------------
dependencia_f <- factor(ds_COR$DS_DEPENDENCIA_ADMINISTRATIVA) ## Fator para split de categoria

ds_COR_dependencia <- ds_COR %>% select(DS_DEPENDENCIA_ADMINISTRATIVA,IMI,IPT) %>% 
  split(dependencia_f, drop = T) %>% ## Separação por dependencia
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_dependencia <- f.print_corr(ds_COR_dependencia)

ds_COR_dependencia <- ds_COR %>% group_by(DS_DEPENDENCIA_ADMINISTRATIVA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_dependencia, by.x = "DS_DEPENDENCIA_ADMINISTRATIVA", by.y = "cat", all = T)
 
 write.csv2(ds_COR_dependencia, paste0(v_path_o, "COR_dependencia.csv"))
 kable(ds_COR_dependencia)
##### ---------------------------------------------------------------------------------------
area_f <- factor(ds_COR$NM_AREA_AVALIACAO) ## Fator para split de categoria

ds_COR_area <- ds_COR %>% select(NM_AREA_AVALIACAO,IMI,IPT) %>% 
  split(area_f, drop = T) %>% ## Separação por area
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_area <- f.print_corr(ds_COR_area)

ds_COR_area <- ds_COR %>% group_by(NM_AREA_AVALIACAO) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_area, by.x = "NM_AREA_AVALIACAO", by.y = "cat", all = T) %>% 
              merge(., ds_siglas, by.x = "NM_AREA_AVALIACAO", by.y = "nome")

 ds_COR_area <- ds_COR_area[,c(13,1:12)]

 write.csv2(ds_COR_area, paste0(v_path_o, "COR_area.csv"))
 kable(ds_COR_area)
##### ---------------------------------------------------------------------------------------
status_f <- factor(ds_COR$CS_STATUS_JURIDICO) ## Fator para split de categoria

ds_COR_status <- ds_COR %>% select(CS_STATUS_JURIDICO,IMI,IPT) %>% 
  split(status_f, drop = T) %>% ## Separação por status
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_status <- f.print_corr(ds_COR_status)

ds_COR_status <- ds_COR %>% group_by(CS_STATUS_JURIDICO) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_status, by.x = "CS_STATUS_JURIDICO", by.y = "cat", all = T)
 
 write.csv2(ds_COR_status, paste0(v_path_o, "COR_status.csv"))
 kable(ds_COR_status)
##### ---------------------------------------------------------------------------------------
modalidade_f <- factor(ds_COR$NM_MODALIDADE_PROGRAMA) ## Fator para split de categoria

ds_COR_modalidade <- ds_COR %>% select(NM_MODALIDADE_PROGRAMA,IMI,IPT) %>% 
  split(modalidade_f, drop = T) %>% ## Separação por modalidade
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_modalidade <- f.print_corr(ds_COR_modalidade)

ds_COR_modalidade <- ds_COR %>% group_by(NM_MODALIDADE_PROGRAMA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_modalidade, by.x = "NM_MODALIDADE_PROGRAMA", by.y = "cat", all = T)

 write.csv2(ds_COR_modalidade, paste0(v_path_o, "COR_modalidade.csv"))
 kable(ds_COR_modalidade)
##### ---------------------------------------------------------------------------------------
regiao_f <- factor(ds_COR$NM_REGIAO) ## Fator para split de categoria

ds_COR_regiao <- ds_COR %>% select(NM_REGIAO,IMI,IPT) %>% 
  split(regiao_f, drop = T) %>% ## Separação por região
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_regiao <- f.print_corr(ds_COR_regiao)

ds_COR_regiao <- ds_COR %>% group_by(NM_REGIAO) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_regiao, by.x = "NM_REGIAO", by.y = "cat", all = T)

 write.csv2(ds_COR_regiao, paste0(v_path_o, "COR_regiao.csv"))
 kable(ds_COR_regiao)
 ##### ---------------------------------------------------------------------------------------
estado_f <- factor(ds_COR$SG_UF_PROGRAMA) ## Fator para split de categoria

ds_COR_estado <- ds_COR %>% select(SG_UF_PROGRAMA,IMI,IPT) %>% 
  split(estado_f, drop = T) %>% ## Separação por UF
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_estado <- f.print_corr(ds_COR_estado)

ds_COR_estado <- ds_COR %>% group_by(SG_UF_PROGRAMA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_estado, by.x = "SG_UF_PROGRAMA", by.y = "cat", all = T)

 write.csv2(ds_COR_estado, paste0(v_path_o, "COR_estado.csv"))
 kable(ds_COR_estado)
##### ---------------------------------------------------------------------------------------
sigla_ies_f <- factor(ds_COR$SG_ENTIDADE_ENSINO) ## Fator para split de categoria

ds_COR_sigla_ies <- ds_COR %>% select(SG_ENTIDADE_ENSINO,IMI,IPT) %>% 
  split(sigla_ies_f, drop = T) %>% ## Separação por sigla da instituição
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_sigla_ies <- f.print_corr(ds_COR_sigla_ies)

ds_COR_sigla_ies <- ds_COR %>% group_by(SG_ENTIDADE_ENSINO) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_sigla_ies, by.x = "SG_ENTIDADE_ENSINO", by.y = "cat", all = T)

 write.csv2(ds_COR_sigla_ies, paste0(v_path_o, "COR_sigla_ies.csv"))
 kable(ds_COR_sigla_ies)
##### ---------------------------------------------------------------------------------------
programa_f <- factor(ds_COR$NM_PROGRAMA_IES) ## Fator para split de categoria

ds_COR_programa <- ds_COR %>% select(NM_PROGRAMA_IES,IMI,IPT) %>% 
  split(programa_f, drop = T) %>% ## Separação por nome do programa
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_programa <- f.print_corr(ds_COR_programa)

ds_COR_programa <- ds_COR %>% group_by(NM_PROGRAMA_IES) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_programa, by.x = "NM_PROGRAMA_IES", by.y = "cat", all = T)

 write.csv2(ds_COR_programa, paste0(v_path_o, "COR_programa.csv"))
 kable(ds_COR_programa)
##### ---------------------------------------------------------------------------------------
grau_f <- factor(ds_COR$NM_GRAU_PROGRAMA) ## Fator para split de categoria

ds_COR_grau <- ds_COR %>% select(NM_GRAU_PROGRAMA,IMI,IPT) %>% 
  split(grau_f, drop = T) %>% ## Separação por grau do programa
  map(f.corr) ## Calculo de correlação para cada segmento

ds_COR_grau <- f.print_corr(ds_COR_grau)

ds_COR_grau <- ds_COR %>% group_by(NM_GRAU_PROGRAMA) %>% 
                         summarise(m_IMI = mean(IMI),                #|
                                   m_IPT = mean(IPT),                #| Média
                                   md_IMI = median(IMI),             #|
                                   md_IPT = median(IPT),             #| Mediana       
                                   v_IMI = var(IMI),                 #|
                                   v_IPT = var(IPT),                 #| Variancia
                                   d_IMI = sd(IMI),                  #|
                                   d_IPT = sd(IPT),                  #| Devio padrão 
                                   pc_IMI = (d_IMI/m_IMI)*100,       #|
                                   pc_IPT = (d_IPT/m_IPT)*100) %>%   #| Percentual do desvio padrão sobre valor esperado
              merge(., ds_COR_grau, by.x = "NM_GRAU_PROGRAMA", by.y = "cat", all = T)

 write.csv2(ds_COR_grau, paste0(v_path_o, "COR_grau.csv"))
 kable(ds_COR_grau)
 ##### ---------------------------------------------------------------------------------------
```


# Avaliação gráfica geral por categorias


```{r Graficos, message=FALSE, warning=FALSE, paged.print=TRUE, fig.height=7, fig.width=10}

f.mplot <- function(ds, label) {
#### Base -------------------------------------------
GGCor <- ggplot(data = ds, aes(x = ds[,1])) + 
  geom_col(aes(y = (as.double(cor)*100)), 
           width = 0.9, 
           alpha=0.4, 
           #stat = "sum",
           col = "black", 
           size = 0.5
           ) +   
  scale_y_continuous(breaks = seq(-100, 100, by = 10)) +  
  geom_hline(yintercept = 0, col = 'black', alpha = 0.7) + 
  geom_hline(yintercept = 39, col = 'orange', alpha = 0.7, size = 1.5) +   
  geom_hline(yintercept = 70, col = '#009900', alpha = 0.7, size = 1.5) + 
  geom_point(aes(y = (as.double(cor)*100)), 
             size=1.8, shape=21, fill="black") + 
  geom_text(aes(y = (as.double(cor)*100) + ifelse(as.double(cor) > 0, 6, -6), 
                label = format(as.double(cor), digits = 4)), 
            size = 5) + 
  theme_light() + 
  theme(axis.text.x = element_text(angle = 0, vjust = 1, size = 14, colour = "black"),
        axis.text.y = element_text(angle = 0, size = 14, colour = "black"),
        axis.title.x = element_text(size = 16, face="bold"),
        axis.title.y = element_text(size = 16, face="bold")) + 
  labs(#title = 'Correlação por Categoria', 
       x = paste0('Categoria (', label, ')'), y = 'Correlação x 100') +
  geom_bar(aes(y = as.double(m_IMI)*100),
           position = position_nudge(x = -0.225),
           width = 0.35, alpha=0.30,
           fill = "red",
           stat = "sum",
           size = 1) +
  geom_bar(aes(y = as.double(m_IPT)*100),
           position = position_nudge(x = 0.225),
           width = 0.35, alpha=0.30,
           fill = "blue",
           stat = "sum",
           size = 1)
return(GGCor)
}

cat("Gráfico para referência (com legenda)")

g_legenda <- f.mplot(ds_COR_dependencia, "Dependência") +
   geom_label(aes(x = 2.55, y = 72, label = 'Correlação forte'), 
              col = '#009900', hjust = 'right', alpha = 0.5, size=4) +  
   geom_label(aes(x = 2.55, y = 41, label = 'Correlação fraca'), 
              col = 'orange', hjust = 'right', alpha = 0.5, size=4) +  
   geom_label(aes(x = 0.6, y = 56, label = 'Média de IMI'), 
              col = 'red', hjust = 'left', alpha = 0.5, size=4) +
   geom_label(aes(x = 1.05, y = 53, label = 'Média de IPT'), 
            col = 'blue', hjust = 'left', alpha = 0.5, size=4) +
   geom_label(aes(x = 1, y = 19.9, label = 'Correlação'), 
            col = 'black', hjust = 'left', alpha = 0.5, size=4)

print(g_legenda)
#ggsave("grafico.png")

cat("Gráficos por categoria")

ds_COR_ano %<>% arrange(ANO_INICIO_PROGRAMA)
print(f.mplot(ds_COR_ano[1:10,], "Ano"))
print(f.mplot(ds_COR_ano[11:20,], "Ano"))
print(f.mplot(ds_COR_ano[21:30,], "Ano"))
print(f.mplot(ds_COR_ano[31:40,], "Ano"))
print(f.mplot(ds_COR_ano[41:50,], "Ano"))
print(f.mplot(ds_COR_ano[51:58,], "Ano"))

ds_COR_area %<>% arrange(desc(cor))
print(f.mplot(ds_COR_area[1:10,], "Area"))
print(f.mplot(ds_COR_area[11:20,], "Area"))
print(f.mplot(ds_COR_area[21:30,], "Area"))
print(f.mplot(ds_COR_area[31:40,], "Area"))
print(f.mplot(ds_COR_area[41:48,], "Area"))

ds_COR_estado %<>% arrange(desc(cor))           # Novo
print(f.mplot(ds_COR_estado[1:4,], "Estado"))  #
print(f.mplot(ds_COR_estado[5:8,], "Estado"))  #
print(f.mplot(ds_COR_estado[9:12,], "Estado")) #
print(f.mplot(ds_COR_estado[13:16,], "Estado")) #
print(f.mplot(ds_COR_estado[17:20,], "Estado")) #
print(f.mplot(ds_COR_estado[21:25,], "Estado")) #

print(f.mplot(ds_COR_conceito, "Conceito"))
print(f.mplot(ds_COR_status, "Status Jurídico"))
print(f.mplot(ds_COR_dependencia, "Dependência"))
print(f.mplot(ds_COR_modalidade, "Modalidade"))
print(f.mplot(ds_COR_grau, "Grau"))     #
print(f.mplot(ds_COR_regiao, "Regiao")) #

```

# Análise geral de IPT e IMI


## Dispersão de IPT e IMI Geral
  
```{r Dispersao, message=FALSE, warning=FALSE, paged.print=TRUE, fig.height=7, fig.width=10}

f.disp <- function(ds) {
  GGDisp <- ggplot(ds, aes(x=IPT, y=IMI)) + 
    geom_point() +
    geom_smooth(method=lm) +
    theme_light() +
    theme(axis.text.x = element_text(angle = 0, size = 17, colour = "black"),
          axis.text.y = element_text(angle = 0, size = 17, colour = "black"),
          axis.title.x = element_text(size = 16, face="bold"),
          axis.title.y = element_text(size = 16, face="bold")) +
    scale_x_continuous(expand = c(0, 0.05), limits = c(0, 5.5)) + 
    scale_y_continuous(expand = c(0, 0), limits = c(0.2, 1))
   
  return(GGDisp)
}

cat("Gráfico de Dispersão de IMI x IPT")
print(f.disp(ds_COR))

cat("Boxplot de IMI e IPT com outliers")
ds_imiipt <- read_excel(paste0(v_path_inter, "IMI_IPT_Geral.xlsx"))

ggplot(ds_imiipt, aes(x=Indice, y=Valores, fill=factor(Indice))) +
    stat_boxplot(geom = "errorbar", width=0.2, size=1) + 
    theme_light() +
    theme(axis.text.x = element_text(angle = 0, size = 16, colour = "black"),
          axis.text.y = element_text(angle = 0, size = 15, colour = "black"),
          axis.title.x = element_text(size = 16, face="bold"),
          axis.title.y = element_text(size = 16, face="bold")) +
    geom_boxplot() +
    scale_fill_manual(values=alpha(c("red", "blue"), 0.3)) +
    theme(legend.position = "none")

#cat("Cluster de IMI e IPT por Area")
#ds_clusterArea <- read_excel(paste0(v_path_inter, "ClusterArea.xlsx"))
#ggplot() + geom_point(data=ds_clusterArea, mapping=aes(x=IPT, y=IMI, colour=Area))
```


## Histogramas de IPT e IMI Geral

```{r Histogramas Geral, message=FALSE, warning=FALSE, paged.print=TRUE, fig.height=7, fig.width=10}

cat("Histogramas Gerais de IMI e IPT")

print(ggplot(ds_COR, aes(x=IMI, fill=sex)) + 
 labs(y = 'Contagem') +
 geom_histogram(colour="black", fill="red", alpha=0.3) +
 theme_light() + 
 theme(panel.grid.minor.x=element_blank(),
       panel.grid.major.x=element_blank()) + 
 theme(axis.text.x = element_text(angle = 0, size = 15, colour = "black"),
       axis.text.y = element_text(angle = 0, size = 15, colour = "black"),
       axis.title.x = element_text(size = 17, face="bold"),
       axis.title.y = element_text(size = 17, face="bold"))
 )
 
print(ggplot(ds_COR, aes(x=IPT, fill=sex)) + 
 labs(y = 'Contagem') +
 geom_histogram(colour="black", fill="blue", alpha=0.3)  +
 theme_light() + 
 theme(panel.grid.minor.x=element_blank(),
       panel.grid.major.x=element_blank()) + 
 theme(axis.text.x = element_text(angle = 0, size = 15, colour = "black"),
       axis.text.y = element_text(angle = 0, size = 15, colour = "black"),
       axis.title.x = element_text(size = 17, face="bold"),
       axis.title.y = element_text(size = 17, face="bold"))
 )

```


# Histogramas de IPT e IMI por Área de Avaliação

```{r Histogramas Área, message=FALSE, warning=FALSE, paged.print=TRUE, fig.height=7, fig.width=10}

f.histo <- function(ds){
#### Histograma por categoria pelo GGPlot2 -------------
 GGHis <- ggplot(ds,aes(ds[,2])) +
   stat_bin(aes(y =..density..,
                fill = ..count..), 
            col = "black",
            binwidth = 0.05, 
            alpha = 0.8) +
   geom_density(fill = "red",
                color = "orange",
                alpha = 0.11) +
   scale_x_continuous(breaks = seq(0, 10, by = 0.10)) +
   #scale_y_continuous(labels = NULL) +
   labs(title = paste0('Histograma de ', v_idx, " - ", v_categ, " - ", ds[1,1]) , x = v_idx, y = 'Contagem') +
   theme(axis.text.x = element_text(angle = 45)) +
   scale_fill_distiller(name = 'Observações',
                        palette = v_pal,
                        direction = 1);GGHis
}

v_categ <- "Área de Avaliação"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_COR %<>% merge(., ds_siglas, by.x = "NM_AREA_AVALIACAO", by.y = "nome")

ds_cat_P <- ds_COR %>%  select(sigla, IPT) %>% 
   split(as.factor(.$sigla)) %>% 
   map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(sigla, IMI) %>% 
  split(as.factor(.$sigla)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
```


# Histogramas de IPT e IMI para demais categorias (Exceto Ano de início)


```{r Histogramas, message=FALSE, warning=FALSE, paged.print=TRUE, fig.height=7, fig.width=10}

v_categ <- "Conceito do Programa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(CD_CONCEITO_PROGRAMA, IPT) %>% 
  split(as.factor(.$CD_CONCEITO_PROGRAMA)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(CD_CONCEITO_PROGRAMA, IMI) %>% 
  split(as.factor(.$CD_CONCEITO_PROGRAMA)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
v_categ <- "Status Jurídico"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(CS_STATUS_JURIDICO, IPT) %>% 
  split(as.factor(.$CS_STATUS_JURIDICO)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(CS_STATUS_JURIDICO, IMI) %>% 
  split(as.factor(.$CS_STATUS_JURIDICO)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
v_categ <- "Dependência Administrativa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(DS_DEPENDENCIA_ADMINISTRATIVA, IPT) %>% 
  split(as.factor(.$DS_DEPENDENCIA_ADMINISTRATIVA)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(DS_DEPENDENCIA_ADMINISTRATIVA, IMI) %>% 
  split(as.factor(.$DS_DEPENDENCIA_ADMINISTRATIVA)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
v_categ <- "Modalidade do Programa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(NM_MODALIDADE_PROGRAMA, IPT) %>% 
  split(as.factor(.$NM_MODALIDADE_PROGRAMA)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(NM_MODALIDADE_PROGRAMA, IMI) %>% 
  split(as.factor(.$NM_MODALIDADE_PROGRAMA)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
# Novo
v_categ <- "Estado-UF do Programa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(SG_UF_PROGRAMA, IPT) %>% 
  split(as.factor(.$SG_UF_PROGRAMA)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(SG_UF_PROGRAMA, IMI) %>% 
  split(as.factor(.$SG_UF_PROGRAMA)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
# Novo
v_categ <- "Região do Programa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(NM_REGIAO, IPT) %>% 
  split(as.factor(.$NM_REGIAO)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(NM_REGIAO, IMI) %>% 
  split(as.factor(.$NM_REGIAO)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}
#####------------------------------------------------------------------------------------------
# Novo
v_categ <- "Grau do Programa"
v_idx <- "IPT"
v_pal <- 'YlGnBu'

ds_cat_P <- ds_COR %>%  select(NM_GRAU_PROGRAMA, IPT) %>% 
  split(as.factor(.$NM_GRAU_PROGRAMA)) %>% 
  map(f.histo);

v_idx <- "IMI"
v_pal <- 'YlGn'

ds_cat_D <- ds_COR %>%  select(NM_GRAU_PROGRAMA, IMI) %>% 
  split(as.factor(.$NM_GRAU_PROGRAMA)) %>% 
  map(f.histo);

for(i in seq_along(ds_cat_P)){
  print(ds_cat_P[[i]])
  print(ds_cat_D[[i]])
}

```

 